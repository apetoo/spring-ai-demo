<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šè½®æ£€ç´¢åæ€ Agent</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .search-box {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        
        .search-group {
            display: flex;
            gap: 15px;
        }
        
        input {
            flex: 1;
            padding: 18px 20px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        button {
            padding: 18px 35px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            min-width: 140px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .progress-bar {
            height: 4px;
            background: #e9ecef;
            overflow: hidden;
            display: none;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s;
        }
        
        .main-content {
            display: flex;
            min-height: 700px;
        }
        
        .process-panel {
            width: 400px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            padding: 20px;
            overflow-y: auto;
        }
        
        .result-panel {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: white;
        }
        
        .step-card {
            background: white;
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: all 0.3s;
        }
        
        .step-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }
        
        .step-header {
            padding: 15px 20px;
            background: #6c757d;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .step-header.completed {
            background: #28a745;
        }
        
        .step-header.processing {
            background: #17a2b8;
        }
        
        .step-header.error {
            background: #dc3545;
        }
        
        .step-title {
            font-weight: 600;
            font-size: 0.95em;
        }
        
        .step-status {
            font-size: 0.85em;
            opacity: 0.9;
        }
        
        .step-content {
            padding: 15px 20px;
            display: none;
            border-top: 1px solid #e9ecef;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .step-content.expanded {
            display: block;
        }
        
        .search-results {
            margin-top: 10px;
        }
        
        .search-result-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            border-left: 4px solid #667eea;
        }
        
        .result-title {
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        
        .result-content {
            color: #6c757d;
            font-size: 0.85em;
            line-height: 1.4;
            margin-bottom: 8px;
        }
        
        .result-score {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75em;
        }
        
        .markdown-content {
            line-height: 1.8;
            color: #333;
        }
        
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            color: #2c3e50;
            margin: 20px 0 15px 0;
        }
        
        .markdown-content h1 {
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .markdown-content h2 {
            border-left: 4px solid #667eea;
            padding-left: 15px;
        }
        
        .markdown-content p {
            margin-bottom: 15px;
        }
        
        .markdown-content ul, .markdown-content ol {
            margin: 15px 0;
            padding-left: 30px;
        }
        
        .markdown-content li {
            margin-bottom: 8px;
        }
        
        .markdown-content code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'SF Mono', 'Monaco', monospace;
        }
        
        .markdown-content pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 15px 0;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
        
        .empty-state h3 {
            font-size: 1.3em;
            margin-bottom: 15px;
            color: #495057;
        }
        
        .example-queries {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .example-query {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
        }
        
        .example-query:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .loading-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status-info {
            padding: 15px 20px;
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            margin-bottom: 20px;
            border-radius: 0 8px 8px 0;
            font-size: 0.95em;
            color: #1565c0;
            display: none;
        }
        
        .expand-icon {
            transition: transform 0.3s;
        }
        
        .expand-icon.expanded {
            transform: rotate(180deg);
        }
        
        .query-info {
            background: #e8f4fd;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            font-size: 0.9em;
        }
        
        .reasoning-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            font-size: 0.9em;
        }
        
        .toggle-link {
            color: #667eea !important;
            cursor: pointer;
            margin-left: 5px;
            text-decoration: underline;
            font-size: 0.85em;
        }
        
        .toggle-link:hover {
            color: #5a6fd8 !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– å¤šè½®æ£€ç´¢åæ€ Agent</h1>
            <p>æ·±åº¦æœç´¢ Â· åæ€ä¼˜åŒ– Â· æ™ºèƒ½æŠ¥å‘Šç”Ÿæˆ</p>
        </div>
        
        <div class="search-box">
            <div class="search-group">
                <input 
                    type="text" 
                    id="query" 
                    placeholder="è¾“å…¥ä½ æƒ³æ·±åº¦ç ”ç©¶çš„ä¸»é¢˜..."
                    value="äººå·¥æ™ºèƒ½åœ¨åŒ»ç–—é¢†åŸŸçš„åº”ç”¨"
                >
                <button onclick="startDeepSearch()" id="btn">å¼€å§‹ç ”ç©¶</button>
            </div>
        </div>
        
        <div class="progress-bar" id="progressBar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        
        <div class="status-info" id="statusInfo">
            æ­£åœ¨åˆå§‹åŒ–æ·±åº¦æœç´¢...
        </div>
        
        <div class="main-content">
            <div class="process-panel" id="processPanel">
                <div class="empty-state">
                    <h3>ğŸš€ å‡†å¤‡å¼€å§‹</h3>
                    <p>è¾“å…¥ä¸»é¢˜å¼€å§‹å¤šè½®æ£€ç´¢åæ€</p>
                    
                    <div class="example-queries">
                        <div class="example-query" onclick="setQuery('åŒºå—é“¾æŠ€æœ¯çš„å‘å±•è¶‹åŠ¿')">åŒºå—é“¾æŠ€æœ¯</div>
                        <div class="example-query" onclick="setQuery('å¯æŒç»­èƒ½æºçš„æœªæ¥')">å¯æŒç»­èƒ½æº</div>
                        <div class="example-query" onclick="setQuery('é‡å­è®¡ç®—çš„å•†ä¸šåº”ç”¨')">é‡å­è®¡ç®—</div>
                        <div class="example-query" onclick="setQuery('å¤§æ¨¡å‹çš„å®‰å…¨æŒ‘æˆ˜')">å¤§æ¨¡å‹å®‰å…¨</div>
                    </div>
                </div>
            </div>
            
            <div class="result-panel" id="resultPanel">
                <div class="empty-state">
                    <h3>ğŸ“„ ç ”ç©¶æŠ¥å‘Š</h3>
                    <p>å®Œæˆç ”ç©¶åï¼Œè¿™é‡Œå°†æ˜¾ç¤ºMarkdownæ ¼å¼çš„æŠ¥å‘Š</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let eventSource = null;
        let currentProgress = 0;
        let currentSteps = {};
        let finalReport = '';
        let currentParagraphId = null;
        let searchResultsBuffer = '';
        let reportStructureBuffer = '';
        let finalReportBuffer = '';
        let isCollectingReport = false;

        function setQuery(query) {
            document.getElementById('query').value = query;
        }

        function startDeepSearch() {
            const query = document.getElementById('query').value.trim();
            if (!query) {
                alert('è¯·è¾“å…¥ç ”ç©¶é—®é¢˜');
                return;
            }

            const btn = document.getElementById('btn');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            const statusInfo = document.getElementById('statusInfo');
            const processPanel = document.getElementById('processPanel');
            const resultPanel = document.getElementById('resultPanel');
            
            // é‡ç½®çŠ¶æ€
            currentProgress = 0;
            currentSteps = {};
            finalReport = '';
            currentParagraphId = null;
            searchResultsBuffer = '';
            reportStructureBuffer = '';
            finalReportBuffer = '';
            isCollectingReport = false;
            progressFill.style.width = '0%';
            
            // æ¸…ç©ºé¢æ¿
            processPanel.innerHTML = '';
            resultPanel.innerHTML = '<div class="empty-state"><h3>ğŸ“„ ç ”ç©¶æŠ¥å‘Š</h3><p>æ­£åœ¨ç”ŸæˆæŠ¥å‘Š...</p></div>';
            
            // æ˜¾ç¤ºè¿›åº¦æ¡å’ŒçŠ¶æ€
            progressBar.style.display = 'block';
            statusInfo.style.display = 'block';
            statusInfo.textContent = 'æ­£åœ¨ç”ŸæˆæŠ¥å‘Šç»“æ„...';
            
            // ç¦ç”¨æŒ‰é’®
            btn.disabled = true;
            btn.innerHTML = '<div class="loading-indicator"><div class="spinner"></div>æ·±åº¦æœç´¢ä¸­</div>';

            // å…³é—­ä¹‹å‰çš„è¿æ¥
            if (eventSource) {
                eventSource.close();
            }

            // å»ºç«‹SSEè¿æ¥
            eventSource = new EventSource(`/api/research?query=${encodeURIComponent(query)}`);

            eventSource.onmessage = function(event) {
                const data = event.data;
                
                // ç´¯ç§¯æŠ¥å‘Šç»“æ„æ•°æ®
                if (data.includes('REPORT_STRUCTURE_START') || reportStructureBuffer.includes('REPORT_STRUCTURE_START')) {
                    reportStructureBuffer += data + '\n';
                    
                    // æ£€æŸ¥æ˜¯å¦æ¥æ”¶å®Œæ•´
                    if (data.includes('REPORT_STRUCTURE_END')) {
                        parseAndDisplayReportStructure(reportStructureBuffer);
                        reportStructureBuffer = '';
                    }
                    return;
                }
                
                // ç´¯ç§¯æœ€ç»ˆæŠ¥å‘Šæ•°æ®
                if (data.includes('FINAL_REPORT_START') || finalReportBuffer.includes('FINAL_REPORT_START')) {
                    finalReportBuffer += data + '\n';
                    
                    // æ£€æŸ¥æ˜¯å¦æ¥æ”¶å®Œæ•´
                    if (data.includes('FINAL_REPORT_END')) {
                        parseAndDisplayFinalReport(finalReportBuffer);
                        finalReportBuffer = '';
                    }
                    return;
                }
                
                // ç´¯ç§¯æœç´¢ç»“æœæ•°æ®
                if (data.includes('SEARCH_RESULTS_START') || data.includes('REFLECTION_SEARCH_RESULTS_START') || 
                    searchResultsBuffer.includes('SEARCH_RESULTS_START') || searchResultsBuffer.includes('REFLECTION_SEARCH_RESULTS_START')) {
                    searchResultsBuffer += data + '\n';
                    
                    // æ£€æŸ¥æ˜¯å¦æ¥æ”¶å®Œæ•´
                    if (data.includes('SEARCH_RESULTS_END') || data.includes('REFLECTION_SEARCH_RESULTS_END')) {
                        parseAndDisplaySearchResults(searchResultsBuffer);
                        searchResultsBuffer = '';
                    }
                    return;
                }
                
                // å¤„ç†æœç´¢æŸ¥è¯¢ç”Ÿæˆï¼ˆåŒ…å«æ€è€ƒè¿‡ç¨‹ï¼‰
                if (data.includes('SEARCH_QUERY_GENERATED_START')) {
                    let buffer = data;
                    // å¦‚æœæ•°æ®ä¸å®Œæ•´ï¼Œå¯èƒ½éœ€è¦ç´¯ç§¯ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå‡è®¾ä¸€æ¬¡æ€§å‘é€æˆ–é€šè¿‡ç»“æŸæ ‡è®°åˆ¤æ–­
                    if (data.includes('SEARCH_QUERY_GENERATED_END')) {
                         parseAndDisplaySearchQuery(buffer);
                    } else {
                         // ç®€å•çš„ç´¯ç§¯é€»è¾‘ï¼Œå®é™…å¯èƒ½éœ€è¦æ›´å¤æ‚çš„bufferå¤„ç†
                         this.searchQueryBuffer = (this.searchQueryBuffer || '') + data + '\n';
                    }
                } else if (this.searchQueryBuffer && (data.includes('SEARCH_QUERY_GENERATED_END') || this.searchQueryBuffer.includes('SEARCH_QUERY_GENERATED_START'))) {
                    this.searchQueryBuffer += data + '\n';
                    if (data.includes('SEARCH_QUERY_GENERATED_END')) {
                        parseAndDisplaySearchQuery(this.searchQueryBuffer);
                        this.searchQueryBuffer = '';
                    }
                    return;
                }

                // å¤„ç†åæ€åˆ†æï¼ˆåŒ…å«æ€è€ƒè¿‡ç¨‹ï¼‰
                if (data.includes('REFLECTION_ANALYSIS_START')) {
                    let buffer = data;
                     if (data.includes('REFLECTION_ANALYSIS_END')) {
                         parseAndDisplayReflectionAnalysis(buffer);
                    } else {
                         this.reflectionAnalysisBuffer = (this.reflectionAnalysisBuffer || '') + data + '\n';
                    }
                } else if (this.reflectionAnalysisBuffer && (data.includes('REFLECTION_ANALYSIS_END') || this.reflectionAnalysisBuffer.includes('REFLECTION_ANALYSIS_START'))) {
                    this.reflectionAnalysisBuffer += data + '\n';
                    if (data.includes('REFLECTION_ANALYSIS_END')) {
                        parseAndDisplayReflectionAnalysis(this.reflectionAnalysisBuffer);
                        this.reflectionAnalysisBuffer = '';
                    }
                    return;
                }
                
                // å¤„ç†ä¸åŒç±»å‹çš„æ¶ˆæ¯
                if (data.includes('ğŸ“‹ æ­£åœ¨ç”ŸæˆæŠ¥å‘Šç»“æ„')) {
                    handleStructureGeneration();
                } else if (data.includes('âœ… æŠ¥å‘Šç»“æ„ç”Ÿæˆå®Œæˆ')) {
                    handleStructureComplete(data);
                } else if (data.includes('ğŸ”„ æ®µè½')) {
                    handleParagraphStart(data);
                } else if (data.includes('ğŸ” ç”Ÿæˆæœç´¢æŸ¥è¯¢')) {
                    handleSearchQueryGeneration(data);
                } else if (data.includes('ğŸŒ æ‰§è¡Œæœç´¢')) {
                    handleSearchExecution(data);
                } else if (data.includes('ğŸ“ æ€»ç»“æœç´¢ç»“æœ')) {
                    handleSummarization(data);
                } else if (data.includes('ğŸ¤” åæ€åˆ†æ')) {
                    handleReflection(data);
                } else if (data.includes('ğŸ” æ‰§è¡Œåæ€æœç´¢')) {
                    handleReflectionSearch(data);
                } else if (data.includes('âœ¨ ä¸°å¯Œå†…å®¹')) {
                    handleEnrichment(data);
                } else if (data.includes('âœ… æ®µè½') && data.includes('å®Œæˆ')) {
                    handleParagraphComplete(data);
                } else if (data.includes('ğŸ“„ æ­£åœ¨ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š')) {
                    handleFinalReportGeneration();
                } else if (data.includes('ğŸ‰ æ·±åº¦ç ”ç©¶å®Œæˆ')) {
                    handleResearchComplete();
                }
                
                // æ›´æ–°è¿›åº¦
                updateProgress(data);
            };

            eventSource.onerror = function() {
                eventSource.close();
                btn.disabled = false;
                btn.textContent = 'å¼€å§‹ç ”ç©¶';
                progressBar.style.display = 'none';
                statusInfo.style.display = 'none';
            };
        }

        function handleStructureGeneration() {
            addStepCard('structure', 'ğŸ“‹ ç”ŸæˆæŠ¥å‘Šç»“æ„', 'processing', 'æ­£åœ¨åˆ†æä¸»é¢˜...');
        }

        function handleStructureComplete(data) {
            const match = data.match(/å…± (\d+) ä¸ªæ®µè½/);
            const count = match ? match[1] : 'æœªçŸ¥';
            updateStepCard('structure', 'ğŸ“‹ ç”ŸæˆæŠ¥å‘Šç»“æ„', 'completed', `å·²ç”Ÿæˆ ${count} ä¸ªæ®µè½`);
        }

        function parseAndDisplayReportStructure(buffer) {
            const lines = buffer.split('\n');
            let paragraphCount = 0;
            let paragraphs = [];
            
            for (let line of lines) {
                line = line.trim();
                
                if (line.startsWith('æ®µè½æ€»æ•°:')) {
                    paragraphCount = parseInt(line.split(':')[1].trim());
                } else if (line.startsWith('æ®µè½ ') && line.includes(':')) {
                    const titleMatch = line.match(/æ®µè½ (\d+): (.+)/);
                    if (titleMatch) {
                        paragraphs.push({
                            number: titleMatch[1],
                            title: titleMatch[2]
                        });
                    }
                }
            }
            
            // æ›´æ–°æŠ¥å‘Šç»“æ„æ­¥éª¤çš„å†…å®¹
            const contentDiv = document.getElementById('content-structure');
            if (contentDiv) {
                contentDiv.innerHTML = `
                    <div class="query-info">
                        <strong>æŠ¥å‘Šç»“æ„åˆ†æ:</strong> å·²ä¸ºä¸»é¢˜ç”Ÿæˆ ${paragraphCount} ä¸ªæ®µè½çš„ç»“æ„åŒ–å¤§çº²
                    </div>
                    <div class="search-results">
                        <h4>æ®µè½ç»“æ„ (${paragraphCount} ä¸ª):</h4>
                        ${paragraphs.map(p => `
                            <div class="search-result-item">
                                <div class="result-title">æ®µè½ ${p.number}: ${p.title}</div>
                            </div>
                        `).join('')}
                    </div>
                    <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 6px; font-size: 0.9em;">
                        ğŸ“ æ¯ä¸ªæ®µè½å°†è¿›è¡Œï¼š<br>
                        â€¢ ç”Ÿæˆé’ˆå¯¹æ€§æœç´¢æŸ¥è¯¢<br>
                        â€¢ æ‰§è¡Œæœç´¢å¹¶è·å–ç›¸å…³ä¿¡æ¯<br>
                        â€¢ æ€»ç»“æœç´¢ç»“æœ<br>
                        â€¢ åæ€åˆ†æå¹¶è¡¥å……æœç´¢<br>
                        â€¢ ä¸°å¯Œå’Œå®Œå–„å†…å®¹
                    </div>
                `;
            }
        }

        function handleParagraphStart(data) {
            const match = data.match(/ğŸ”„ æ®µè½ (\d+): (.+)/);
            if (match) {
                const paragraphId = `paragraph-${match[1]}`;
                const title = match[2].trim();
                currentParagraphId = paragraphId;
                addStepCard(paragraphId, `ğŸ“ æ®µè½ ${match[1]}: ${title}`, 'processing', 'å¼€å§‹å¤„ç†...');
            }
        }

        function handleSearchQueryGeneration(data) {
            // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æœç´¢æŸ¥è¯¢çš„è¯¦ç»†ä¿¡æ¯
        }

        function handleSearchExecution(data) {
            const match = data.match(/æ‰¾åˆ° (\d+) æ¡ç»“æœ/);
            if (match) {
                // è§£ææœç´¢ç»“æœ
                parseSearchResults(data);
            }
        }

        function handleSummarization(data) {
            // å¤„ç†æ€»ç»“æ­¥éª¤
        }

        function handleReflection(data) {
            // å¤„ç†åæ€æ­¥éª¤
        }

        function handleReflectionSearch(data) {
            // å¤„ç†åæ€æœç´¢æ­¥éª¤
        }

        function handleEnrichment(data) {
            // å¤„ç†å†…å®¹ä¸°å¯Œæ­¥éª¤
        }

        function handleParagraphComplete(data) {
            const match = data.match(/âœ… æ®µè½ (\d+) å®Œæˆ/);
            if (match) {
                const paragraphId = `paragraph-${match[1]}`;
                updateStepCard(paragraphId, `ğŸ“ æ®µè½ ${match[1]}`, 'completed', 'å¤„ç†å®Œæˆ');
            }
        }

        function handleFinalReportGeneration() {
            addStepCard('final-report', 'ğŸ“„ ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š', 'processing', 'æ•´åˆæ‰€æœ‰å†…å®¹...');
        }

        function handleResearchComplete() {
            updateStepCard('final-report', 'ğŸ“„ ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š', 'completed', 'æŠ¥å‘Šç”Ÿæˆå®Œæˆ');
            
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            const btn = document.getElementById('btn');
            btn.disabled = false;
            btn.textContent = 'å¼€å§‹ç ”ç©¶';
            
            // éšè—è¿›åº¦æ¡
            setTimeout(() => {
                document.getElementById('progressBar').style.display = 'none';
                document.getElementById('statusInfo').style.display = 'none';
            }, 2000);
        }

        function addStepCard(id, title, status, statusText) {
            const processPanel = document.getElementById('processPanel');
            
            const stepCard = document.createElement('div');
            stepCard.className = 'step-card';
            stepCard.id = `step-${id}`;
            
            stepCard.innerHTML = `
                <div class="step-header ${status}" onclick="toggleStepContent('${id}')">
                    <div class="step-title">${title}</div>
                    <div class="step-status">${statusText}</div>
                    <div class="expand-icon">â–¼</div>
                </div>
                <div class="step-content" id="content-${id}">
                    <div>è¯¦ç»†ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º...</div>
                </div>
            `;
            
            processPanel.appendChild(stepCard);
            currentSteps[id] = { title, status, statusText };
        }

        function updateStepCard(id, title, status, statusText) {
            const stepCard = document.getElementById(`step-${id}`);
            if (stepCard) {
                const header = stepCard.querySelector('.step-header');
                const statusElement = stepCard.querySelector('.step-status');
                
                header.className = `step-header ${status}`;
                statusElement.textContent = statusText;
                
                currentSteps[id] = { title, status, statusText };
            }
        }

        function toggleStepContent(id) {
            const content = document.getElementById(`content-${id}`);
            const icon = document.querySelector(`#step-${id} .expand-icon`);
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                icon.classList.remove('expanded');
            } else {
                content.classList.add('expanded');
                icon.classList.add('expanded');
            }
        }

        function parseAndDisplayFinalReport(buffer) {
            console.log('æ”¶åˆ°çš„æœ€ç»ˆæŠ¥å‘Šç¼“å†²åŒº:', buffer); // è°ƒè¯•ä¿¡æ¯
            
            const lines = buffer.split('\n');
            let reportContent = '';
            let isInReport = false;
            
            for (let line of lines) {
                if (line.includes('FINAL_REPORT_START')) {
                    isInReport = true;
                    continue;
                } else if (line.includes('FINAL_REPORT_END')) {
                    isInReport = false;
                    break;
                } else if (isInReport) {
                    reportContent += line + '\n';
                }
            }
            
            console.log('è§£æå‡ºçš„æŠ¥å‘Šå†…å®¹:', reportContent); // è°ƒè¯•ä¿¡æ¯
            
            // æ¸…ç†æŠ¥å‘Šå†…å®¹ï¼Œç§»é™¤å¯èƒ½çš„JSONæ ¼å¼
            let cleanedReport = reportContent.trim();
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯JSONæ ¼å¼ï¼Œå¦‚æœæ˜¯åˆ™å°è¯•è§£æ
            if (cleanedReport.startsWith('[') || cleanedReport.startsWith('{')) {
                console.log('æ£€æµ‹åˆ°JSONæ ¼å¼ï¼Œå°è¯•è§£æ...');
                try {
                    // å¦‚æœæ˜¯JSONæ•°ç»„æ ¼å¼ï¼Œæå–å†…å®¹
                    const jsonData = JSON.parse(cleanedReport);
                    if (Array.isArray(jsonData)) {
                        // å¦‚æœæ˜¯æ®µè½æ•°ç»„ï¼Œç»„åˆæˆæŠ¥å‘Š
                        cleanedReport = jsonData.map(item => {
                            if (item.title && item.paragraph_latest_state) {
                                return `## ${item.title}\n\n${item.paragraph_latest_state}\n`;
                            }
                            return '';
                        }).join('\n');
                    }
                } catch (e) {
                    console.log('JSONè§£æå¤±è´¥ï¼Œä½¿ç”¨åŸå§‹å†…å®¹');
                }
            }
            
            // æ›´æ–°å…¨å±€å˜é‡
            finalReport = cleanedReport;
            
            console.log('æœ€ç»ˆæŠ¥å‘Šå†…å®¹:', finalReport); // è°ƒè¯•ä¿¡æ¯
            
            // æ›´æ–°å³ä¾§é¢æ¿
            updateFinalReport();
            
            // æ›´æ–°æœ€ç»ˆæŠ¥å‘Šæ­¥éª¤çš„å†…å®¹
            const contentDiv = document.getElementById('content-final-report');
            if (contentDiv && finalReport.trim()) {
                const reportPreview = truncateText(finalReport.replace(/[#*\n]/g, ' '), 100);
                contentDiv.innerHTML = `
                    <div class="query-info">
                        <strong>æœ€ç»ˆæŠ¥å‘Š:</strong> å·²ç”Ÿæˆå®Œæ•´çš„Markdownæ ¼å¼ç ”ç©¶æŠ¥å‘Š
                    </div>
                    <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 6px; font-size: 0.9em;">
                        <strong>æŠ¥å‘Šé¢„è§ˆ:</strong><br>
                        ${reportPreview}
                    </div>
                    <div style="margin-top: 10px; font-size: 0.85em; color: #6c757d;">
                        ğŸ“„ å®Œæ•´æŠ¥å‘Šè¯·æŸ¥çœ‹å³ä¾§é¢æ¿
                    </div>
                `;
            }
        }

        function updateFinalReport() {
            const resultPanel = document.getElementById('resultPanel');
            
            if (finalReport.trim()) {
                // ä½¿ç”¨marked.jsæ¸²æŸ“markdown
                const htmlContent = marked.parse(finalReport);
                resultPanel.innerHTML = `<div class="markdown-content">${htmlContent}</div>`;
                
                // é«˜äº®ä»£ç å—
                resultPanel.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
            } else {
                resultPanel.innerHTML = '<div class="empty-state"><h3>ğŸ“„ ç ”ç©¶æŠ¥å‘Š</h3><p>æ­£åœ¨ç”ŸæˆæŠ¥å‘Š...</p></div>';
            }
        }

        function updateProgress(data) {
            const statusInfo = document.getElementById('statusInfo');
            const progressFill = document.getElementById('progressFill');
            
            // æ ¹æ®è¾“å‡ºå†…å®¹æ›´æ–°è¿›åº¦
            if (data.includes('ğŸ“‹ æ­£åœ¨ç”ŸæˆæŠ¥å‘Šç»“æ„')) {
                currentProgress = 10;
                statusInfo.textContent = 'ğŸ“‹ æ­£åœ¨ç”ŸæˆæŠ¥å‘Šç»“æ„...';
            } else if (data.includes('âœ… æŠ¥å‘Šç»“æ„ç”Ÿæˆå®Œæˆ')) {
                currentProgress = 20;
                statusInfo.textContent = 'âœ… æŠ¥å‘Šç»“æ„ç”Ÿæˆå®Œæˆ';
            } else if (data.includes('ğŸ”„ æ®µè½')) {
                currentProgress = Math.min(currentProgress + 12, 80);
                const match = data.match(/ğŸ”„ æ®µè½ (\d+):/);
                if (match) {
                    statusInfo.textContent = `ğŸ”„ æ­£åœ¨å¤„ç†æ®µè½ ${match[1]}...`;
                }
            } else if (data.includes('ğŸ“„ æ­£åœ¨ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š')) {
                currentProgress = 90;
                statusInfo.textContent = 'ğŸ“„ æ­£åœ¨ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š...';
            } else if (data.includes('ğŸ‰ æ·±åº¦ç ”ç©¶å®Œæˆ')) {
                currentProgress = 100;
                statusInfo.textContent = 'ğŸ‰ æ·±åº¦ç ”ç©¶å®Œæˆï¼';
            }
            
            progressFill.style.width = currentProgress + '%';
        }

        function parseAndDisplaySearchResults(buffer) {
            if (!currentParagraphId) return;
            
            const isReflectionSearch = buffer.includes('REFLECTION_SEARCH_RESULTS_START');
            const lines = buffer.split('\n');
            
            let query = '';
            let results = [];
            let currentResult = null;
            
            for (let line of lines) {
                line = line.trim();
                
                if (line.startsWith('æŸ¥è¯¢:') || line.startsWith('åæ€æŸ¥è¯¢:')) {
                    query = line.split(':')[1].trim();
                } else if (line === 'RESULT_ITEM_START') {
                    currentResult = {};
                } else if (line === 'RESULT_ITEM_END') {
                    if (currentResult) {
                        results.push(currentResult);
                        currentResult = null;
                    }
                } else if (currentResult && line.includes(':')) {
                    const [key, ...valueParts] = line.split(':');
                    const value = valueParts.join(':').trim();
                    
                    if (key === 'æ ‡é¢˜') currentResult.title = value;
                    else if (key === 'å†…å®¹') currentResult.content = value;
                    else if (key === 'åˆ†æ•°') currentResult.score = parseFloat(value);
                    else if (key === 'é“¾æ¥') currentResult.url = value;
                }
            }
            
            // æ›´æ–°æ­¥éª¤å¡ç‰‡å†…å®¹
            updateStepCardWithSearchResults(currentParagraphId, query, results, isReflectionSearch);
        }

        function parseAndDisplaySearchQuery(buffer) {
            if (!currentParagraphId) return;
            const contentDiv = document.getElementById(`content-${currentParagraphId}`);
            if (!contentDiv) return;

            let query = '';
            let reasoning = '';
            
            const lines = buffer.split('\n');
            for (let line of lines) {
                if (line.startsWith('æŸ¥è¯¢:')) query = line.split(':')[1].trim();
                else if (line.startsWith('æ€è€ƒ:')) reasoning = line.split(':')[1].trim();
            }
            
            const html = `
                <div class="reasoning-info">
                    <strong>ğŸ¤” æ€è€ƒè¿‡ç¨‹:</strong> ${reasoning}
                </div>
                <div class="query-info">
                    <strong>ğŸ” ç”ŸæˆæŸ¥è¯¢:</strong> ${query}
                </div>
            `;
            
            if (contentDiv.innerText.includes('è¯¦ç»†ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º...')) {
                contentDiv.innerHTML = html;
            } else {
                contentDiv.innerHTML += html;
            }
        }

        function parseAndDisplayReflectionAnalysis(buffer) {
            if (!currentParagraphId) return;
            const contentDiv = document.getElementById(`content-${currentParagraphId}`);
            if (!contentDiv) return;

            let query = '';
            let reasoning = '';
            
            const lines = buffer.split('\n');
            for (let line of lines) {
                if (line.startsWith('åæ€æŸ¥è¯¢:')) query = line.split(':')[1].trim();
                else if (line.startsWith('æ€è€ƒ:')) reasoning = line.split(':')[1].trim();
            }
            
            const html = `
                <div style="margin-top: 15px; border-top: 1px dashed #dee2e6; padding-top: 15px;"></div>
                <div class="reasoning-info" style="background-color: #e8f5e9; border-color: #c8e6c9;">
                    <strong>ğŸ¤” åæ€æ€è€ƒ:</strong> ${reasoning}
                </div>
                <div class="query-info" style="background-color: #f1f8e9; border-color: #dcedc8;">
                    <strong>ğŸ” åæ€æŸ¥è¯¢:</strong> ${query}
                </div>
            `;
            
            contentDiv.innerHTML += html;
        }

        function truncateText(text, maxLength = 50) {
            if (!text) return '';
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        function updateStepCardWithSearchResults(paragraphId, query, results, isReflection) {
            const contentDiv = document.getElementById(`content-${paragraphId}`);
            if (!contentDiv) return;
            
            // å¦‚æœè¿˜æœ‰å ä½ç¬¦ï¼Œå…ˆæ¸…ç©º
            if (contentDiv.innerText.includes('è¯¦ç»†ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º...')) {
                contentDiv.innerHTML = '';
            }

            const searchType = isReflection ? 'åæ€æœç´¢' : 'åˆæ¬¡æœç´¢';
            const searchHtml = `
                <div class="search-results">
                    <h4>${searchType}ç»“æœ (${results.length} æ¡):</h4>
                    ${results.map((result, index) => {
                        const shortContent = truncateText(result.content, 50);
                        const resultId = `result-${paragraphId}-${isReflection ? 'reflection' : 'initial'}-${index}`;
                        return `
                            <div class="search-result-item">
                                <div class="result-title">${result.title}</div>
                                <div class="result-content" id="${resultId}-short">
                                    ${shortContent}
                                    ${result.content.length > 50 ? 
                                        `<span class="toggle-link" onclick="toggleFullContent('${resultId}')">å±•å¼€å…¨æ–‡</span>` 
                                        : ''
                                    }
                                </div>
                                <div class="result-content" id="${resultId}-full" style="display: none;">
                                    ${result.content}
                                    <span class="toggle-link" onclick="toggleFullContent('${resultId}')">æ”¶èµ·</span>
                                </div>
                                <div style="margin-top: 8px;">
                                    <span class="result-score">åˆ†æ•°: ${result.score.toFixed(2)}</span>
                                    <a href="${result.url}" target="_blank" style="margin-left: 10px; font-size: 0.8em; color: #667eea;">æŸ¥çœ‹åŸæ–‡</a>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            // å§‹ç»ˆè¿½åŠ å†…å®¹ï¼Œä¸å†æ›¿æ¢ï¼Œå› ä¸ºå¯èƒ½å·²ç»æœ‰æ€è€ƒè¿‡ç¨‹äº†
            contentDiv.innerHTML += searchHtml;
        }

        function toggleFullContent(resultId) {
            const shortDiv = document.getElementById(`${resultId}-short`);
            const fullDiv = document.getElementById(`${resultId}-full`);
            
            if (shortDiv.style.display === 'none') {
                // å½“å‰æ˜¾ç¤ºå…¨æ–‡ï¼Œåˆ‡æ¢åˆ°ç®€çŸ­ç‰ˆæœ¬
                shortDiv.style.display = 'block';
                fullDiv.style.display = 'none';
            } else {
                // å½“å‰æ˜¾ç¤ºç®€çŸ­ç‰ˆæœ¬ï¼Œåˆ‡æ¢åˆ°å…¨æ–‡
                shortDiv.style.display = 'none';
                fullDiv.style.display = 'block';
            }
        }

        // æ”¯æŒå›è½¦é”®æœç´¢
        document.getElementById('query').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                startDeepSearch();
            }
        });
    </script>
</body>
</html>